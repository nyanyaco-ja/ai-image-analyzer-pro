# AI Image Analyzer Pro v1.6.1 - Release Notes

**リリース日**: 2025年10月25日

## 🔧 バグフィックス・改善

### 1. **文書画像検出機能の追加** 📄

CLIP（意味的類似度）が**医療カルテ・文書画像を誤判定する問題**を解決しました。

#### 問題の詳細

CLIPは自然画像の評価に優れていますが、**医療カルテ・スキャン文書などのテキスト主体の画像**では、構造的類似性を過大評価し、内容が全く異なる文書でも高スコア（0.90-0.95）を返す問題がありました。

**例（v1.6での誤判定）:**
```
元画像: 医療カルテA（患者: 田中太郎、診断: インフルエンザ）
画像1:  医療カルテB（患者: 佐藤花子、診断: 骨折）

CLIP類似度: 0.9356  ← 全く異なる患者なのに高スコア
評価: 「意味的に非常に類似」❌ ← 誤判定
```

#### 実装した解決策

##### 🔍 自動文書検出アルゴリズム

以下の特徴から文書画像を自動検出：

1. **白背景率** > 60% AND **色分散** < 50
2. **グレースケール率** > 80% AND **白背景率** > 40%

検出対象:
- 医療カルテ（電子カルテ、紙カルテ）
- 診療報酬明細書、処方箋
- レシート、契約書、請求書
- スキャンされた文書

##### ⚖️ 文書専用の厳格な評価基準

| 評価 | 自然画像（通常） | 文書画像（厳格） |
|------|--------------|--------------|
| 意味的にほぼ同一 | > 0.95 | > 0.98 |
| 意味的に類似 | > 0.85 | > 0.95 |
| 要注意（構造類似） | - | > 0.90 |
| 全く異なる | ≤ 0.85 | ≤ 0.90 |

##### 📊 改善された出力例

**Before（v1.6）:**
```
画像1 vs 元画像 CLIP: 0.9356
  画像1: 意味的に非常に類似  ← 誤った評価
```

**After（v1.6.1）:**
```
  📄 文書画像を検出 (白背景: 93.1%, 色分散: 55.7, グレー率: 100.0%)
  ⚠️  文書/カルテ画像を検出: CLIPは厳格な基準で評価します
画像1 vs 元画像 CLIP: 0.9356
  画像1: 意味的に類似（要注意：文書は構造類似で高スコアになりやすい）
```

---

### 2. **幻覚検出の厳格化（文書画像）** 🚨

文書画像検出時、CLIP + LPIPS統合幻覚検出の閾値を動的に調整：

| 検出項目 | 自然画像 | 文書画像 |
|---------|---------|---------|
| 重大警告（幻覚） | CLIP < 0.70 | CLIP < 0.90 |
| 高品質確認 | CLIP > 0.85 | CLIP > 0.95 |

**出力例:**
```
【🔬 CLIP + LPIPS 統合幻覚検出】
📄 文書/カルテ画像検出: CLIPに厳格な基準を適用
🚨 重大警告【画像2】: CLIP & LPIPS両方で異常検出
   - 幻覚の可能性が極めて高い (CLIP: 0.9040 < 0.90)
```

---

### 3. **データ構造の拡張**

`results['clip_similarity']` に文書フラグを追加：

**Before（v1.6）:**
```python
results['clip_similarity'] = {
    'img1_vs_original': 0.9356,
    'img2_vs_original': 0.9040
}
```

**After（v1.6.1）:**
```python
results['clip_similarity'] = {
    'img1_vs_original': 0.9356,
    'img2_vs_original': 0.9040,
    'is_document': True  # ← 文書フラグ
}
```

---

## 📝 技術詳細

### 実装ファイル

- **advanced_image_analyzer.py**
  - `is_document_image()` 関数（188-229行目）
  - CLIP計算時の文書検出と厳格評価（1191-1295行目）

- **result_interpreter.py**
  - 文書対応の解釈ロジック（159-230行目）
  - 文書対応の幻覚検出（632-689行目）

### テストファイル

- `test_document_detection_simple.py` - 文書検出ロジックの単体テスト

### ドキュメント

- `docs/clip_document_detection.md` - 文書画像検出機能の詳細ドキュメント

---

## ✅ テスト結果

### 単体テスト（100% 成功）

```
✅ 医療カルテ風画像    → 文書として検出
✅ カラフルな自然画像  → 自然画像として検出
✅ スキャン文書風画像  → 文書として検出
✅ 通常の写真         → 自然画像として検出
```

### 実運用テスト（医療カルテ3枚）

**Before（v1.6）:**
- 画像1（異なる患者）: CLIP 0.9356 → 「非常に類似」❌

**After（v1.6.1）:**
- 画像1（異なる患者）: CLIP 0.9356 → 「構造は類似だが内容は異なる可能性 🔍」✅

---

## 🎯 影響を受けるユースケース

### ✅ 改善されるケース

1. **医療カルテの品質評価**
   - 異なる患者のカルテを正しく「異なる」と判定
   - 同一患者でも診断内容が異なる場合に警告

2. **スキャン文書の比較**
   - 契約書、請求書などの文書比較で誤判定を防止

3. **レシート・領収書の検証**
   - 異なる取引のレシートを正しく区別

### ⚠️ 変更されないケース

1. **自然画像（医療画像含む）**
   - レントゲン、CT、MRI → 従来通りの基準
   - 顕微鏡画像、衛星画像 → 従来通りの基準
   - 風景、人物写真 → 従来通りの基準

2. **CLIP以外のメトリクス**
   - PSNR、SSIM、LPIPS、Sharpness等 → 変更なし

---

## 🔮 今後の改善予定

### 検討中の機能

1. **OCRベースの内容比較**
   - pytesseractでテキスト抽出
   - 患者名、診断名などの実際の内容を比較

2. **文書専用モデルの導入**
   - LayoutLMv3やDonutなどの文書理解モデル
   - 医療文書に特化した判定

---

## 📌 注意事項

### CLIPの制限

CLIPはOCR機能を持たないため、**文書のテキスト内容（患者名、診断名など）を読み取ることはできません**。

文書画像の正確な一致判定には、以下の指標を併用することを推奨します：

- **PSNR**: ピクセルレベルの正確な一致
- **SSIM**: 構造的類似度（レイアウト変更を検出）
- **LPIPS**: 知覚的類似度（人間の見た目に近い）

---

## 🔗 関連リリース

- **v1.6** (2025-10-25): CLIP Embeddings機能の初期実装
- **v1.5** (2025-10-24): クリーンデータセット抽出機能
- **v1.4** (2025-10-23): GUI改善とバグ修正

---

## 📧 フィードバック

この機能についてのフィードバックは以下まで：

- GitHub Issues: https://github.com/yourusername/image_compare/issues
- Email: your.email@example.com

**v1.6.1は医療カルテ・文書画像の正確な評価を実現する重要なアップデートです。**
