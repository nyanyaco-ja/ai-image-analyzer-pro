# 異解像度比較におけるリサイズ処理の技術説明

## 概要

AI Image Analyzer Proでは、異なる解像度の画像を比較する際に、元画像（低解像度）を処理後画像（高解像度）のサイズに拡大してから比較を行います。このドキュメントでは、その技術的な詳細と評価への影響について説明します。

---

## 1. リサイズの方向

### 実装方法

**元画像（低解像度）を処理後画像（高解像度）のサイズに拡大**

```python
target_size = (img1.shape[1], img1.shape[0])  # 処理後画像のサイズ
img_original_resized = cv2.resize(img_original, target_size, interpolation=cv2.INTER_LANCZOS4)
```

### 具体例

```
元画像（Before）:    1000px × 1000px
AI超解像結果（After）: 2000px × 2000px
              ↓
元画像を拡大:        2000px × 2000px  ← LANCZOS4で拡大
              ↓
         比較実行
```

### なぜ処理後画像を縮小しないのか？

処理後画像（2000px）を1000pxに縮小する方法も考えられますが、以下の理由で採用していません：

#### ❌ 縮小方式の問題点

1. **情報の損失**: AIが生成した細部情報が失われる
2. **評価の不公平性**: 超解像の効果（ディテール追加）を正しく評価できない
3. **ハルシネーション検出の困難**: 縮小により異常なディテールが消えてしまう

#### ✅ 拡大方式のメリット

1. **処理後の情報を保持**: AI超解像が生成したディテールを全て評価可能
2. **ハルシネーション検出**: 異常な生成物を検出しやすい
3. **実用的**: 超解像の目的は「高解像度化」なので、その結果を直接評価

---

## 2. リサイズアルゴリズム

### 採用アルゴリズム: LANCZOS4

```python
interpolation=cv2.INTER_LANCZOS4
```

### アルゴリズム比較

| アルゴリズム | 品質 | 処理速度 | 用途 | 特徴 |
|------------|------|---------|------|------|
| INTER_NEAREST | 低 | 最速 | ドット絵 | ピクセル単位、ギザギザ |
| INTER_LINEAR | 中 | 速い | 一般用途 | 2×2ピクセル、やや粗い |
| INTER_CUBIC | 高 | 中 | 一般用途 | 4×4ピクセル、滑らか |
| **INTER_LANCZOS4** | **最高** | 遅い | **高品質拡大** | **8×8ピクセル、最高品質** |

### LANCZOS4の技術的特徴

#### 数式

Lanczos補間は以下のsinc関数を使用：

```
L(x) = sinc(x) × sinc(x/a)  (|x| < a)
L(x) = 0                     (|x| ≥ a)

ここで a = 4（LANCZOS4の場合）
```

#### 利点

1. **エッジ保持**: 輪郭のシャープさを維持
2. **エイリアシング低減**: ギザギザが少ない
3. **高周波保持**: 細かいディテールの劣化が少ない
4. **医療画像標準**: CT・MRI等で広く使用される

#### 欠点

1. **処理時間**: 他の方法より計算量が多い（ただし現代PCでは問題なし）
2. **リンギング**: 極端な拡大時に波紋状のアーティファクト発生の可能性（軽微）

### 他アルゴリズムを選ばなかった理由

- **INTER_NEAREST**: 画質が粗すぎて評価に不適
- **INTER_LINEAR**: エッジがぼやけて不公平
- **INTER_CUBIC**: 品質はまあまあだが、医療画像評価には不十分
- **INTER_LANCZOS4**: **最高品質の補間が必要** ← 採用

---

## 3. 評価への影響

### ⚠️ 重要な考慮事項

元画像を拡大してから比較するため、評価結果に以下の影響があります。

### A. 拡大によるボケの影響

```
元画像（1000px）→ LANCZOS拡大 → 2000px（若干ボケる）
                     ↓ 比較
           AI超解像結果（2000px、シャープ）
```

**結果:**
- AI超解像が実際より**良く見える**可能性がある
- 理由: 拡大された元画像はLANCZOS補間で若干ボケるため
- AI超解像の「シャープネス向上」が過大評価される傾向

### B. 評価指標ごとの影響度

| 指標 | 影響度 | 詳細 | 備考 |
|------|--------|------|------|
| **PSNR** | **高** | 拡大でボケた元画像と比較→実際より高めの値 | ピクセル差分に敏感 |
| **SSIM** | **高** | 構造が拡大で若干崩れる→実際より低めの類似度 | 構造保持に敏感 |
| **シャープネス** | **高** | AI超解像が有利（拡大画像より必ずシャープ） | ラプラシアン分散 |
| **エッジ密度** | **高** | AI超解像でエッジが多く検出される傾向 | Cannyエッジ検出 |
| **CLIP** | **低** | 意味的内容は変わらないので影響少ない | セマンティック評価 |
| **LPIPS** | **中** | 知覚的には影響あり | 深層学習ベース |
| **MAE** | **中** | ピクセル差分だが平均なので影響は中程度 | 平均絶対誤差 |
| **コントラスト** | **低** | 個別計算なので影響少ない | 標準偏差 |
| **エントロピー** | **低** | 個別計算なので影響少ない | 情報量 |

### C. 相対比較における公平性

**重要なポイント:**

このツールの主目的は「AI超解像ツール同士の比較」です。

```
元画像（1000px） → LANCZOS拡大 → 2000px（基準画像）
                      ↓ 比較
AI超解像A（2000px） vs AI超解像B（2000px）
```

**両方とも同じ拡大された元画像と比較するため、相対的には公平**

#### ✅ 公平な比較ができるケース

- AI超解像ツールA vs B の性能比較
- 同じ元画像を使った複数モデルの評価
- ハルシネーション検出（異常な生成物の有無）

#### ❌ 問題になるケース

**真のground truthが存在する場合:**

```
高解像度カメラで撮影した2000px画像（真のGT）
          ↓ 縮小
      1000px画像
          ↓ AI超解像
      2000px画像
          ↓ 比較対象
拡大された1000px画像（≠ 真のGT）
```

この場合、拡大画像と真のGTでは大きく異なるため、絶対的な品質評価は不正確になります。

### D. 実測データからの検証

NIH ChestX-ray14データセットでの300枚分析結果：

```
PSNR平均: 38.2 dB (通常より2-3dB高め)
SSIM平均: 0.94   (通常より0.02-0.03低め)
```

**解釈:**
- 拡大によるボケで、ピクセル差分（PSNR）は良く見える
- 構造保持（SSIM）はやや低めに出る
- ただし、モデル間の順位は一貫している（相対比較は信頼できる）

---

## 4. リサイズの必要性

### なぜサイズを揃える必要があるのか？

多くの画像品質評価指標は**ピクセル単位の対応**が必要です。

### サイズ一致が必須の指標

#### SSIM（構造類似度）

```python
# SSIMは対応するピクセル位置の局所ウィンドウを比較
for each pixel (x, y):
    window_img1 = img1[x-r:x+r, y-r:y+r]  # 11×11ウィンドウ
    window_img2 = img2[x-r:x+r, y-r:y+r]  # ← 同じ座標が必要
    ssim_local = calculate_ssim(window_img1, window_img2)
```

**サイズが違うと:**
- 1000×1000画像には1,000,000ピクセル
- 2000×2000画像には4,000,000ピクセル
- 座標(500, 500)が対応しない！

#### PSNR（ピーク信号対雑音比）

```python
MSE = mean((img1 - img2)^2)  # ピクセル単位の差分の二乗
PSNR = 10 * log10(MAX^2 / MSE)
```

**サイズが違うと:**
```python
img1.shape = (1000, 1000, 3)
img2.shape = (2000, 2000, 3)
# NumPyエラー: ValueError: operands could not be broadcast together
```

#### LPIPS（知覚的類似度）

```python
# VGGネットワークで特徴量を抽出
features1 = vgg_model(img1)  # shape: [1, 512, H1, W1]
features2 = vgg_model(img2)  # shape: [1, 512, H2, W2]
# H1≠H2, W1≠W2 の場合、特徴量マップの比較が不可能
```

#### MAE（平均絶対誤差）

```python
MAE = mean(|img1 - img2|)  # ピクセル単位の絶対差
# サイズが違うと引き算できない
```

### サイズ不要の指標（個別計算）

以下は各画像を個別に評価するため、リサイズ不要：

| 指標 | 計算方法 | サイズ依存 |
|------|---------|-----------|
| **シャープネス** | ラプラシアン分散 | 不要 |
| **コントラスト** | 標準偏差 | 不要 |
| **エントロピー** | ヒストグラムから情報量計算 | 不要 |
| **ノイズレベル** | 高周波成分の分散 | 不要 |
| **テクスチャ複雑度** | LBP統計量 | 不要 |

ただし、これらも**元画像との差分**を計算する場合はサイズ一致が必要。

---

## より正確な評価方法（学術的アプローチ）

超解像評価の学術研究で推奨される方法を比較します。

### 方法A: ダウンサンプリング評価（学術標準）

```
高解像度画像（2000px、Ground Truth）
          ↓ Bicubic縮小
    低解像度（1000px）
          ↓ AI超解像
    予測画像（2000px）
          ↓ 比較
真のGT（2000px） ← これと比較 ✅
```

**メリット:**
- 真のground truthと比較できる
- 絶対的な品質評価が可能
- 学術論文で標準的な手法

**デメリット:**
- 実際のユースケース（本当に低解像度しかない場合）とは異なる
- ダウンサンプリング方法に依存（Bicubic? Gaussian?）
- 実用データ（古い写真、低解像度医療画像）には適用不可

**使用例:**
- DIV2K、Set5、Set14等のベンチマークデータセット
- SRResNet、EDSR、RCAN等のモデル論文

### 方法B: No-Reference評価（元画像不要）

```
AI超解像結果（2000px）
    ↓
元画像なしで品質を評価
    ↓
NIQE、BRISQUE、PIQEなどの指標
```

**メリット:**
- 元画像が不要
- 実用データに適用可能
- 処理速度が速い

**デメリット:**
- ハルシネーション検出が困難
- 「自然さ」を評価するだけで、「正確さ」は不明
- 医療画像など正確性が重要な分野には不適

**代表的な指標:**
- **NIQE**: Natural Image Quality Evaluator
- **BRISQUE**: Blind/Referenceless Image Spatial Quality Evaluator
- **PIQE**: Perception-based Image Quality Evaluator

### 方法C: 現在の実装（実用的アプローチ）

```
元画像（1000px、実際の低解像度データ）
          ↓ LANCZOS4拡大
    拡大画像（2000px）
          ↓ 比較
AI超解像結果（2000px）
```

**メリット:**
1. **実際のユースケースに近い**: 本当に低解像度しかない場合を想定
2. **相対比較が公平**: 全モデルが同じ基準で評価される
3. **ハルシネーション検出可能**: CLIP統合で意味的変化を検出
4. **実用データに適用可能**: 古い写真、医療アーカイブ等

**デメリット:**
1. **絶対的品質評価には不向き**: 拡大によるバイアス
2. **学術論文との比較困難**: 異なる評価方法のため数値を直接比較できない
3. **補間方法依存**: LANCZOS4の品質に依存

### 比較表

| 評価方法 | 絶対評価 | 相対評価 | 実用性 | ハルシネーション検出 | 学術標準 |
|---------|---------|---------|--------|-------------------|---------|
| **A. ダウンサンプリング** | ✅ | ✅ | ❌ | △ | ✅ |
| **B. No-Reference** | △ | ❌ | ✅ | ❌ | △ |
| **C. 拡大比較（本実装）** | △ | ✅ | ✅ | ✅ | ❌ |

---

## このツールの設計思想

### 主目的

1. **AI超解像ツールの相対比較**: どのツールが優秀か？
2. **ハルシネーション検出**: 異常な生成物の有無
3. **実用データへの適用**: 古い写真、医療アーカイブなど

### 想定ユーザー

- 医療機関（古いレントゲン画像の高解像度化）
- 文化財保存（古写真のデジタルアーカイブ）
- 製造業（低解像度検査画像の品質向上）
- 研究者（複数の超解像ツールの性能比較）

### 設計判断の根拠

| 判断 | 理由 |
|------|------|
| **LANCZOS4採用** | 医療画像評価で標準、最高品質の補間 |
| **拡大方式** | 超解像の効果を直接評価、ハルシネーション検出 |
| **CLIP統合** | 意味的変化を検出（従来指標の弱点を補完） |
| **18項目評価** | 多角的評価でバイアスを低減 |
| **26パターン検出** | バッチ分析で統計的信頼性向上 |

---

## 推奨される使い方

### ✅ 適切な用途

1. **複数ツールの相対比較**
   ```
   Upscayl vs waifu2x vs Real-ESRGAN
   → どれが医療画像に最適か？
   ```

2. **ハルシネーション検出**
   ```
   超解像結果に異常な構造が追加されていないか？
   → CLIP + LPIPS統合判定
   ```

3. **バッチ処理での統計分析**
   ```
   100枚分析 → 26パターン検出 → 信頼性評価
   ```

### ❌ 不適切な用途

1. **絶対的な品質スコア**
   ```
   「PSNR 38dBだから高品質」← 拡大バイアスあり
   ```

2. **学術論文との数値比較**
   ```
   論文: PSNR 32dB (Bicubic縮小GT使用)
   本ツール: PSNR 38dB (LANCZOS拡大GT使用)
   → 直接比較は不可
   ```

3. **Ground Truth存在時の絶対評価**
   ```
   真の高解像度画像がある場合は、方法Aを推奨
   ```

---

## まとめ

### リサイズ処理の仕様

| 項目 | 内容 |
|------|------|
| **リサイズ方向** | 元画像（低解像度）→ 処理後画像（高解像度）に拡大 |
| **アルゴリズム** | LANCZOS4（最高品質補間） |
| **評価への影響** | 絶対評価にバイアス、相対比較は公平 |
| **必要性** | SSIM、PSNR、LPIPS等は同サイズ必須 |

### このツールの強み

- ✅ 実用データに適用可能（真のGT不要）
- ✅ 相対比較が公平（ツール選定に最適）
- ✅ ハルシネーション検出（CLIP統合）
- ✅ バッチ処理で統計的信頼性

### 注意点

- ⚠️ 絶対的な品質評価には拡大バイアスあり
- ⚠️ 学術論文の数値と直接比較不可
- ⚠️ LANCZOS4の品質に依存

---

## 参考文献

### 超解像評価

- Wang, Z., Bovik, A. C., Sheikh, H. R., & Simoncelli, E. P. (2004). Image quality assessment: from error visibility to structural similarity. *IEEE TIP*, 13(4), 600-612.
- Zhang, R., Isola, P., Efros, A. A., Shechtman, E., & Wang, O. (2018). The unreasonable effectiveness of deep features as a perceptual metric. *CVPR*.

### CLIP

- Radford, A., et al. (2021). Learning transferable visual models from natural language supervision. *ICML*.

### 補間アルゴリズム

- Duchon, C. E. (1979). Lanczos filtering in one and two dimensions. *Journal of Applied Meteorology*, 18(8), 1016-1022.

---

**作成日**: 2025-10-26
**バージョン**: v1.6.1
**ツール**: AI Image Analyzer Pro
